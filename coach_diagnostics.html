<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Netiquette-Coach Diagnosetool</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    h1 { font-size: 1.2rem; margin: 0 0 12px; }
    label { display:block; margin:10px 0 4px; }
    input, textarea, button, select { font: inherit; padding: 8px; }
    textarea { width: 100%; min-height: 80px; }
    .row { display:flex; gap:8px; flex-wrap: wrap; margin:10px 0; }
    .row > * { flex: 1 1 auto; }
    pre { background:#f6f8fa; padding:12px; overflow:auto; max-height: 50vh; border:1px solid #e1e4e8; }
    small { color:#666; }
  </style>
</head>
<body>
  <h1>Netiquette‑Coach Diagnosetool</h1>
  <p><small>Dieses Tool testet die Erreichbarkeit deiner Serverless‑Funktion <code>/api/ask</code> und zeigt HTTP‑Status, CORS‑Header und Antwort an. Es verändert NICHT dein Layout.</small></p>

  <label for="endpoint">Endpoint (absolute URL empfohlen)</label>
  <input id="endpoint" type="text" value="https://chat-netiquette.vercel.app/api/ask"/>

  <label for="prompt">Prompt</label>
  <textarea id="prompt">Bitte antworte als Netiquette‑Coach freundlich in 1‑2 Sätzen.</textarea>

  <div class="row">
    <button id="btnPost">POST testen</button>
    <button id="btnGet">GET testen (?prompt=...)</button>
    <button id="btnRel">Relativen Endpoint testen (/api/ask @ aktuellem Origin)</button>
  </div>

  <div class="row">
    <button id="btnCopy">Bericht kopieren</button>
    <button id="btnDownload">Bericht als JSON speichern</button>
  </div>

  <label>Ergebnis</label>
  <pre id="log">Noch keine Tests…</pre>

<script>
  const $ = sel => document.querySelector(sel);
  const logEl = $("#log");
  let lastReport = {};

  function serializeHeaders(h) {
    const out = {};
    try { for (const [k,v] of h.entries()) out[k] = v; } catch(e) {}
    return out;
  }

  async function runTest({method="POST", endpoint, prompt}) {
    const report = {
      when: new Date().toISOString(),
      origin: location.origin,
      userAgent: navigator.userAgent,
      method,
      endpoint,
      promptPreview: (prompt||"").slice(0,120),
      timingMs: null,
      ok: null,
      status: null,
      statusText: null,
      responseHeaders: {},
      bodyTextPreview: "",
      json: null,
      error: null
    };
    const t0 = performance.now();
    try {
      let res;
      if (method === "GET") {
        const url = new URL(endpoint, location.href);
        url.searchParams.set("prompt", prompt);
        res = await fetch(url.toString(), { method: "GET" });
      } else {
        res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
      }
      report.timingMs = Math.round(performance.now()-t0);
      report.ok = res.ok;
      report.status = res.status;
      report.statusText = res.statusText;
      report.responseHeaders = serializeHeaders(res.headers);
      const clone = res.clone();
      let txt = "";
      try { txt = await clone.text(); } catch (_) {}
      report.bodyTextPreview = txt.slice(0, 800);
      try { report.json = JSON.parse(txt); } catch(_) {}
    } catch (e) {
      report.timingMs = Math.round(performance.now()-t0);
      report.ok = false;
      report.error = String(e && e.message ? e.message : e);
    }
    lastReport = report;
    logEl.textContent = JSON.stringify(report, null, 2);
  }

  $("#btnPost").addEventListener("click", () => {
    runTest({ method: "POST", endpoint: $("#endpoint").value.trim(), prompt: $("#prompt").value.trim() });
  });

  $("#btnGet").addEventListener("click", () => {
    runTest({ method: "GET", endpoint: $("#endpoint").value.trim(), prompt: $("#prompt").value.trim() });
  });

  $("#btnRel").addEventListener("click", () => {
    const rel = new URL("/api/ask", location.href).toString();
    runTest({ method: "POST", endpoint: rel, prompt: $("#prompt").value.trim() });
  });

  $("#btnCopy").addEventListener("click", async () => {
    const text = JSON.stringify(lastReport, null, 2);
    try { await navigator.clipboard.writeText(text); alert("Bericht kopiert."); }
    catch { alert("Konnte nicht in die Zwischenablage schreiben."); }
  });

  $("#btnDownload").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(lastReport, null, 2)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "coach_diagnostics_report.json";
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
  });
</script>
</body>
</html>
